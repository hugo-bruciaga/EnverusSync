/*
Deployment script for EnverusSync

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "EnverusSync"
:setvar DefaultFilePrefix "EnverusSync"
:setvar DefaultDataPath "C:\Users\hbadmin\AppData\Local\Microsoft\VisualStudio\SSDT\EnverusSync"
:setvar DefaultLogPath "C:\Users\hbadmin\AppData\Local\Microsoft\VisualStudio\SSDT\EnverusSync"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering Procedure [sync].[spSaveFullDirectionalSurvey]...';


GO
/***********************************************************************************

	Procedure Name:		sync.spFullDirectionalSurvey
	Author:				Enterprise Database Development Team
	______________________________________________________________________________

	Purpose:			
	  TODO: Add text to describe the purpose of the procedure

	Parameters:
	  @Param1 (varchar 128)
		Description goes here

	  @Param2 (varchar 128)
		Description goes here

	Returns:
	  TODO: Add help text to describe any return values and/or result sets

	Remarks:
	  TODO: Add help text to provide more detailed usage instructions

	Example:
	  TODO: Add examples of calling and using the stored procedure
	______________________________________________________________________________

***********************************************************************************/
ALTER PROCEDURE sync.spSaveFullDirectionalSurvey (
	 @data			VARCHAR(max)
	,@NoOutput		BIT				= 0
)
AS
BEGIN
	SET XACT_ABORT ON
	SET NOCOUNT ON

	--------------------------------------------------------------------------------
	-- Variable Declaration
	--------------------------------------------------------------------------------
		DECLARE
			 @ErrPos			VARCHAR(512)	= ''
			,@ErrMsg			VARCHAR(2048)	= ''
			,@MsgTitle			VARCHAR(256)	= concat('Execute ', object_schema_name(@@procid), '.', object_name(@@procid))
	
		-- Parameter Override
		SELECT @NoOutput = coalesce(@NoOutput, 0)

	--------------------------------------------------------------------------------
	-- BEGIN TRY... CATCH
	--------------------------------------------------------------------------------
		BEGIN TRY
			PRINT concat(sysdatetime(),' | INFO | ',@MsgTitle, '; *** Started ***')

			------------------------------------------------------------------------
			-- Validate Parameters
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Validate parameters')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				  -- @data
				  PRINT concat(sysdatetime(),' | INFO | ',@ErrPos,'; @data')
			  	  IF ISJSON(@data) = 0
				  BEGIN
				      SET @ErrMsg = 'The @data must be a well formed JSON structure';
					  THROW 2147483647,@ErrMsg,1;
				  END
				  
			------------------------------------------------------------------------
			-- Initialize procedure resources
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Initialize procedure resources')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				  -- #FullDirectionalSurvey
				  PRINT concat(sysdatetime(),' | INFO | ',@ErrPos,'; #FullDirectionalSurvey')
			  
				  DROP TABLE IF EXISTS #FullDirectionalSurvey
				  CREATE TABLE #FullDirectionalSurvey (
					 _row_id						BIGINT IDENTITY(1,1)	NOT NULL	PRIMARY KEY CLUSTERED
					,_delete						BIT			NULL
					,_duplicate						BIT			NULL
					,_error							BIT			NULL
					,_message						VARCHAR		NULL

					,API_UWI					  	VARCHAR(32)	NULL
					,API_UWI_Unformatted			VARCHAR(32)	NULL
					,API_UWI_12						VARCHAR(32)	NULL
					,API_UWI_12_Unformatted	   		VARCHAR(32)	NOT NULL
					,Azimuth_DEG				   	FLOAT		NULL
					,Closure_FT				   		TINYINT		NULL
					,CoordinateSource				VARCHAR(64)	NULL
					,Country						VARCHAR(2)	NULL
					,County							VARCHAR(32)	NULL
					,Course_FT						FLOAT		NULL
					,DeletedDate					DATETIME	NULL
					,DogLegSeverity_DEGPer100FT		FLOAT		NULL
					,E_W							FLOAT		NULL
					,ENVBasin						VARCHAR(64)	NULL
					,ENVInterval					VARCHAR(128) NULL
					,ENVPlay						VARCHAR(128) NULL
					,ENVRegion						VARCHAR(32)	NULL
					,GeomXYZ_Point					sys.GEOMETRY NULL
					,GridX_FT						FLOAT		NULL
					,GridY_FT						FLOAT		NULL
					,Inclination_DEG				FLOAT		NULL
					,Latitude						FLOAT		NULL
					,Longitude						FLOAT		NULL
					,MeasuredDepth_FT				FLOAT		NULL
					,N_S							FLOAT		NULL
					,StateProvince					VARCHAR(64)	NULL
					,StationNumber					BIGINT		NOT NULL
					,SubseaElevation_FT				FLOAT		NULL
					,TVD_FT							FLOAT		NULL
					,UpdatedDate					DATETIME	NULL
					,VerticalSection_FT				TINYINT		NULL
					,WellId							BIGINT		NULL
					,X_ECEF							FLOAT		NULL
					,Y_ECEF							FLOAT		NULL
					,Z_ECEF							FLOAT		NULL
					,ETL_Load_Date					DATETIME	NULL
				  
					,INDEX idx_tempdb_FullDirectionalSurvey_API_UWI_12_StationNumber
						NONCLUSTERED (
							API_UWI_12, StationNumber
						)
				  )

			------------------------------------------------------------------------
			-- Save FullDirectionalSurvey data
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Save FullDirectionalSurvey data')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				--------------------------------------------------------------------
				-- Unpack FullDirectionalSurvey JSON
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Unpack FullDirectionalSurvey JSON')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					INSERT INTO #FullDirectionalSurvey (
						 _duplicate
						,_error
						,_delete

						,API_UWI					  
						,API_UWI_Unformatted		  
						,API_UWI_12				  
						,API_UWI_12_Unformatted	  
						,Azimuth_DEG				  
						,Closure_FT				  
						,CoordinateSource		  
						,Country					  
						,County					  
						,Course_FT				  
						,DeletedDate				  
						,DogLegSeverity_DEGPer100FT
						,E_W						  
						,ENVBasin				  
						,ENVInterval				  
						,ENVPlay					  
						,ENVRegion				  
						,GridX_FT				  
						,GridY_FT				  
						,Inclination_DEG			  
						,Latitude				  
						,Longitude				  
						,MeasuredDepth_FT		  
						,N_S						  
						,StateProvince			  
						,StationNumber			  
						,SubseaElevation_FT		  
						,TVD_FT					  
						,UpdatedDate				  
						,VerticalSection_FT		  
						,WellId					  
						,X_ECEF					  
						,Y_ECEF					  
						,Z_ECEF			
						,GeomXYZ_Point			  						

						,ETL_Load_Date			  
					
						)
					SELECT
						 _duplicate = count(*) OVER (PARTITION BY t0.API_UWI_12, t0.StationNumber)-1
						,_error		= 0
						,_delete							BIT

						,API_UWI					  
						,API_UWI_Unformatted		  
						,API_UWI_12				  
						,API_UWI_12_Unformatted	  
						,Azimuth_DEG				  
						,Closure_FT				  
						,CoordinateSource		  
						,Country					  
						,County					  
						,Course_FT				  
						,DeletedDate				  
						,DogLegSeverity_DEGPer100FT
						,E_W						  
						,ENVBasin				  
						,ENVInterval				  
						,ENVPlay					  
						,ENVRegion				  
						,GridX_FT				  
						,GridY_FT				  
						,Inclination_DEG			  
						,Latitude				  
						,Longitude				  
						,MeasuredDepth_FT		  
						,N_S						  
						,StateProvince			  
						,StationNumber			  
						,SubseaElevation_FT		  
						,TVD_FT					  
						,UpdatedDate				  
						,VerticalSection_FT		  
						,WellId					  
						,X_ECEF					  
						,Y_ECEF					  
						,Z_ECEF			
						,t1.GeoData GeomXYZ_Point

						,sysdatetime()
					FROM
						OPENJSON(@data)
						WITH (
							 _delete						BIT

							,API_UWI					  	VARCHAR(32)	
							,API_UWI_Unformatted			VARCHAR(32)	
							,API_UWI_12						VARCHAR(32)	
							,API_UWI_12_Unformatted	   		VARCHAR(32)	
							,Azimuth_DEG				   	FLOAT		
							,Closure_FT				   		TINYINT		
							,CoordinateSource				VARCHAR(64)	
							,Country						VARCHAR(2)	
							,County							VARCHAR(32)	
							,Course_FT						FLOAT		
							,DeletedDate					DATETIME	
							,DogLegSeverity_DEGPer100FT		FLOAT		
							,E_W							FLOAT		
							,ENVBasin						VARCHAR(64)	
							,ENVInterval					VARCHAR(128)
							,ENVPlay						VARCHAR(128)
							,ENVRegion						VARCHAR(32)	
							,GeomXYZ_Point					VARCHAR(MAX)
							,GridX_FT						FLOAT		
							,GridY_FT						FLOAT		
							,Inclination_DEG				FLOAT		
							,Latitude						FLOAT		
							,Longitude						FLOAT		
							,MeasuredDepth_FT				FLOAT		
							,N_S							FLOAT		
							,StateProvince					VARCHAR(64)	
							,StationNumber					BIGINT		
							,SubseaElevation_FT				FLOAT		
							,TVD_FT							FLOAT		
							,UpdatedDate					DATETIME	
							,VerticalSection_FT				TINYINT		
							,WellId							BIGINT		
							,X_ECEF							FLOAT		
							,Y_ECEF							FLOAT		
							,Z_ECEF							FLOAT		
							--,ETL_Load_Date				DATETIME
						) t0
						CROSS APPLY [sync].[fnGetGeometryFromStr](t0.GeomXYZ_Point) t1

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Validate FullDirectionalSurvey data
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Validate FullDirectionalSurvey data')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					UPDATE #FullDirectionalSurvey SET 
						 _delete	= coalesce(_delete, 0)
						,_error		= CASE 
										-- Set error true if duplicate detected
										WHEN _duplicate = 1 THEN 1
										
										-- Set error true if API_UWI_12, StationNumber is null
										
										--WHEN API_UWI_12 IS NULL OR API_UWI_12 = '' THEN 1
										WHEN API_UWI_12 IS NULL THEN 1
										--WHEN StationNumber IS NULL OR StationNumber = '' THEN 1
										WHEN StationNumber IS NULL THEN 1
										ELSE 0
									  END
						,_message	=   -- Add error message duplicate detected
									+ CASE WHEN _duplicate = 1 THEN '[ERROR: There were one or more records with the same API_UWI_12,StationNumber this record will be ignored ( '+[API_UWI_12]+','+[StationNumber]+')];' ELSE '' END
									+ CASE WHEN API_UWI_12 IS NULL THEN '[ERROR: API_UWI_12 cannot be null)];' ELSE '' END
									+ CASE WHEN StationNumber IS NULL  THEN '[ERROR: StationNumber cannot be null)];' ELSE '' END
								
					
					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Save data to data.FullDirectionalSurveys
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Save data to data.FullDirectionalSurvey')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					----------------------------------------------------------------
					-- Process Deletes
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.FullDirectionalSurvey; Process Deletes')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						DELETE t0
						FROM
							data.FullDirectionalSurvey t0

							INNER JOIN #FullDirectionalSurvey t1
							   ON t0.API_UWI_12 = t1.API_UWI_12
							  AND t0.StationNumber = t1.StationNumber
							  
						WHERE 1=1
							AND t1.DeletedDate IS NULL
							AND t1._delete = 1
							AND t1._error = 0

						SET @ErrPos += concat(' [ ',@@rowcount,' ]')
						PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

					----------------------------------------------------------------
					-- Process Updates
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.FullDirectionalSurvey; Process Updates')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						UPDATE t0 SET	
							 API_UWI					  	= t1.API_UWI					  	
							,API_UWI_Unformatted			= t1.API_UWI_Unformatted			
							,API_UWI_12						= t1.API_UWI_12						
							,API_UWI_12_Unformatted	   		= t1.API_UWI_12_Unformatted	   		
							,Azimuth_DEG				   	= t1.Azimuth_DEG				   	
							,Closure_FT				   		= t1.Closure_FT				   		
							,CoordinateSource				= t1.CoordinateSource				
							,Country						= t1.Country						
							,County							= t1.County							
							,Course_FT						= t1.Course_FT						
							,DeletedDate					= t1.DeletedDate					
							,DogLegSeverity_DEGPer100FT		= t1.DogLegSeverity_DEGPer100FT		
							,E_W							= t1.E_W							
							,ENVBasin						= t1.ENVBasin						
							,ENVInterval					= t1.ENVInterval					
							,ENVPlay						= t1.ENVPlay						
							,ENVRegion						= t1.ENVRegion						
							,GeomXYZ_Point					= t1.GeomXYZ_Point					
							,GridX_FT						= t1.GridX_FT						
							,GridY_FT						= t1.GridY_FT						
							,Inclination_DEG				= t1.Inclination_DEG				
							,Latitude						= t1.Latitude						
							,Longitude						= t1.Longitude						
							,MeasuredDepth_FT				= t1.MeasuredDepth_FT				
							,N_S							= t1.N_S							
							,StateProvince					= t1.StateProvince					
							,StationNumber					= t1.StationNumber					
							,SubseaElevation_FT				= t1.SubseaElevation_FT				
							,TVD_FT							= t1.TVD_FT							
							,UpdatedDate					= t1.UpdatedDate					
							,VerticalSection_FT				= t1.VerticalSection_FT				
							,WellId							= t1.WellId							
							,X_ECEF							= t1.X_ECEF							
							,Y_ECEF							= t1.Y_ECEF							
							,Z_ECEF							= t1.Z_ECEF							
							,ETL_Load_Date					= t1.ETL_Load_Date
						FROM
							data.FullDirectionalSurvey t0

							INNER JOIN #FullDirectionalSurvey t1
								ON t0.API_UWI_12 = t1.API_UWI_12
							   AND t0.StationNumber = t1.StationNumber


						WHERE 1=1
							AND t1._delete = 0
							AND t1._error = 0

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

					----------------------------------------------------------------
					-- Process Inserts
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.FullDirectionalSurvey; Process Inserts')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						INSERT INTO data.FullDirectionalSurvey (					
							 API_UWI					  
							,API_UWI_Unformatted		  
							,API_UWI_12				  
							,API_UWI_12_Unformatted	  
							,Azimuth_DEG				  
							,Closure_FT				  
							,CoordinateSource		  
							,Country					  
							,County					  
							,Course_FT				  
							,DeletedDate				  
							,DogLegSeverity_DEGPer100FT
							,E_W						  
							,ENVBasin				  
							,ENVInterval				  
							,ENVPlay					  
							,ENVRegion				  
							,GeomXYZ_Point			  
							,GridX_FT				  
							,GridY_FT				  
							,Inclination_DEG			  
							,Latitude				  
							,Longitude				  
							,MeasuredDepth_FT		  
							,N_S						  
							,StateProvince			  
							,StationNumber			  
							,SubseaElevation_FT		  
							,TVD_FT					  
							,UpdatedDate				  
							,VerticalSection_FT		  
							,WellId					  
							,X_ECEF					  
							,Y_ECEF					  
							,Z_ECEF					  
							,ETL_Load_Date
							)
						SELECT					
							 API_UWI					  	= t0.API_UWI					  	
							,API_UWI_Unformatted			= t0.API_UWI_Unformatted			
							,API_UWI_12						= t0.API_UWI_12						
							,API_UWI_12_Unformatted	   		= t0.API_UWI_12_Unformatted	   		
							,Azimuth_DEG				   	= t0.Azimuth_DEG				   	
							,Closure_FT				   		= t0.Closure_FT				   		
							,CoordinateSource				= t0.CoordinateSource				
							,Country						= t0.Country						
							,County							= t0.County							
							,Course_FT						= t0.Course_FT						
							,DeletedDate					= t0.DeletedDate					
							,DogLegSeverity_DEGPer100FT		= t0.DogLegSeverity_DEGPer100FT		
							,E_W							= t0.E_W							
							,ENVBasin						= t0.ENVBasin						
							,ENVInterval					= t0.ENVInterval					
							,ENVPlay						= t0.ENVPlay						
							,ENVRegion						= t0.ENVRegion						
							,GeomXYZ_Point					= t0.GeomXYZ_Point					
							,GridX_FT						= t0.GridX_FT						
							,GridY_FT						= t0.GridY_FT						
							,Inclination_DEG				= t0.Inclination_DEG				
							,Latitude						= t0.Latitude						
							,Longitude						= t0.Longitude						
							,MeasuredDepth_FT				= t0.MeasuredDepth_FT				
							,N_S							= t0.N_S							
							,StateProvince					= t0.StateProvince					
							,StationNumber					= t0.StationNumber					
							,SubseaElevation_FT				= t0.SubseaElevation_FT				
							,TVD_FT							= t0.TVD_FT							
							,UpdatedDate					= t0.UpdatedDate					
							,VerticalSection_FT				= t0.VerticalSection_FT				
							,WellId							= t0.WellId							
							,X_ECEF							= t0.X_ECEF							
							,Y_ECEF							= t0.Y_ECEF							
							,Z_ECEF							= t0.Z_ECEF							
							,ETL_Load_Date					= t0.ETL_Load_Date				
						FROM
							#FullDirectionalSurvey t0

							LEFT OUTER JOIN data.FullDirectionalSurvey t1
								ON t0.API_UWI_12 = t1.API_UWI_12
							   AND t0.StationNumber = t1.StationNumber


						WHERE 1=1
							AND t1.API_UWI_12		IS NULL

							AND t0._delete = 0
							AND t0._error = 0

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Error Output
				--------------------------------------------------------------------
					IF @NoOutput = 0
					BEGIN
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.FullDirectionalSurvey')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						SELECT 
							 _row_id
                            ,_delete
                            ,_error
                            ,_message

							,API_UWI					  	
							,API_UWI_Unformatted			
							,API_UWI_12						
							,API_UWI_12_Unformatted	   		
							,Azimuth_DEG				   	
							,Closure_FT				   		
							,CoordinateSource				
							,Country						
							,County							
							,Course_FT						
							,DeletedDate					
							,DogLegSeverity_DEGPer100FT		
							,E_W							
							,ENVBasin						
							,ENVInterval					
							,ENVPlay						
							,ENVRegion						
							,GeomXYZ_Point					
							,GridX_FT						
							,GridY_FT						
							,Inclination_DEG				
							,Latitude						
							,Longitude						
							,MeasuredDepth_FT				
							,N_S							
							,StateProvince					
							,StationNumber					
							,SubseaElevation_FT				
							,TVD_FT							
							,UpdatedDate					
							,VerticalSection_FT				
							,WellId							
							,X_ECEF							
							,Y_ECEF							
							,Z_ECEF							


							,ETL_Load_Date
						FROM 
							#FullDirectionalSurvey
						WHERE 1=1
							AND _error = 1

						SET @ErrPos += concat(' [ ',@@rowcount,' ]')
						PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)
					END

		END TRY
		BEGIN CATCH
			-- Errors here are fatal; format and throw exception to caller
			SET @ErrMsg = concat('Failed to ',@ErrPos,'  { ',error_number(),' } ',error_message())
			PRINT concat(sysdatetime(),' | *ERR | ',@ErrMsg);
			THROW 2147483647,@ErrMsg,1;
		END CATCH	
		
		PRINT concat(sysdatetime(),' | INFO | ',@MsgTitle, '; *** Completed ***')
END
GO
PRINT N'Altering Procedure [sync].[spSavePermit]...';


GO
/***********************************************************************************

	Procedure Name:		sync.spPermit
	Author:				Enterprise Database Development Team
	______________________________________________________________________________

	Purpose:			
	  TODO: Add text to describe the purpose of the procedure

	Parameters:
	  @Param1 (varchar 128)
		Description goes here

	  @Param2 (varchar 128)
		Description goes here

	Returns:
	  TODO: Add help text to describe any return values and/or result sets

	Remarks:
	  TODO: Add help text to provide more detailed usage instructions

	Example:
	  TODO: Add examples of calling and using the stored procedure
	______________________________________________________________________________

***********************************************************************************/
ALTER PROCEDURE sync.spSavePermit (
	 @data			VARCHAR(max)
	,@NoOutput		BIT				= 0
)
AS
BEGIN
	SET XACT_ABORT ON
	SET NOCOUNT ON

	--------------------------------------------------------------------------------
	-- Variable Declaration
	--------------------------------------------------------------------------------
		DECLARE
			 @ErrPos			VARCHAR(512)	= ''
			,@ErrMsg			VARCHAR(2048)	= ''
			,@MsgTitle			VARCHAR(256)	= concat('Execute ', object_schema_name(@@procid), '.', object_name(@@procid))
	
		-- Parameter Override
		SELECT @NoOutput = coalesce(@NoOutput, 0)

	--------------------------------------------------------------------------------
	-- BEGIN TRY... CATCH
	--------------------------------------------------------------------------------
		BEGIN TRY
			PRINT concat(sysdatetime(),' | INFO | ',@MsgTitle, '; *** Started ***')

			------------------------------------------------------------------------
			-- Validate Parameters
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Validate parameters')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				  -- @data
				  PRINT concat(sysdatetime(),' | INFO | ',@ErrPos,'; @data')
			  	  IF ISJSON(@data) = 0
				  BEGIN
				      SET @ErrMsg = 'The @data must be a well formed JSON structure';
					  THROW 2147483647,@ErrMsg,1;
				  END
				  
			------------------------------------------------------------------------
			-- Initialize procedure resources
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Initialize procedure resources')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				  -- #Permit
				  PRINT concat(sysdatetime(),' | INFO | ',@ErrPos,'; #Permit')
			  
				  DROP TABLE IF EXISTS #Permit
				  CREATE TABLE #Permit (
					 _row_id						 BIGINT IDENTITY(1,1)	NOT NULL	PRIMARY KEY CLUSTERED
					,_delete						 BIT			NULL
					,_duplicate						 BIT			NULL
					,_error							 BIT			NULL
					,_message						 VARCHAR		NULL

					,[Abstract]                      VARCHAR (8)      
					,[Amended_Date]                  DATETIME         
					,[API_UWI]                       VARCHAR (32)     
					,[API_UWI_Unformatted]           VARCHAR (32)     
					,[ApprovedDate]                  DATETIME         
					,[Block]                         VARCHAR (16)     
					,[ContactName]                   VARCHAR (128)    
					,[ContactPhone]                  VARCHAR (32)     
					,[Country]                       VARCHAR (64)     
					,[County]                        VARCHAR (64)     
					,[DeletedDate]                   DATETIME         
					,[District]                      VARCHAR (16)     
					,[ENVBasin]                      VARCHAR (64)     
					,[ENVInterval]                   VARCHAR (128)    
					,[ENVOperator]                   VARCHAR (256)    
					,[ENVPeerGroup]                  VARCHAR (64)     
					,[ENVPlay]                       VARCHAR (128)    
					,[ENVRegion]                     VARCHAR (32)     
					,[ENVStockExchange]              VARCHAR (32)     
					,[ENVTicker]                     VARCHAR (8)      
					,[ENVWellStatus]                 VARCHAR (64)     
					,[ExpiredDate]                   DATETIME         
					,[Field]                         VARCHAR (64)     
					,[Formation]                     VARCHAR (256)    
					,[GeomBHL_Point]               [sys].[geometry] 
					,[GeomPermitted_Line]          [sys].[geometry] 
					,[GeomSHL_Point]               [sys].[geometry] 
					,[H2SArea]                       INT              
					,[Latitude]                      FLOAT (53)       
					,[Latitude_BH]                   FLOAT (53)       
					,[Lease_Acres]                   FLOAT (53)       
					,[LeaseName]                     VARCHAR (64)     
					,[LeaseNumber]                   VARCHAR (64)     
					,[Longitude]                     FLOAT (53)       
					,[Longitude_BH]                  FLOAT (53)       
					,[OperatorAddress]               VARCHAR (128)    
					,[OperatorCity]                  VARCHAR (32)     
					,[OperatorCity_30mi]             VARCHAR (16)     
					,[OperatorCity_50mi]             VARCHAR (16)     
					,[OperatorState]                 VARCHAR (16)     
					,[OperatorZip]                   VARCHAR (16)     
					,[PadID]                         VARCHAR (128)    
					,[PermitDepth_FT]                INT              
					,[PermitID]                      INT              
					,[PermitNumber]                  VARCHAR (32)     
					,[PermitStatus]                  VARCHAR (16)     
					,[PermittedLateralLength_FT]     FLOAT (53)       
					,[PermittedLateralLengthSource]  VARCHAR (16)     
					,[PermittedMeasuredDepth_FT]     INT              
					,[PermittedTrueVerticalDepth_FT] INT              
					,[PermitType]                    VARCHAR (16)     
					,[Range]                         VARCHAR (4)      
					,[RawOperator]                   VARCHAR (128)    
					,[Section]                       VARCHAR (8)      
					,[StateProvince]                 VARCHAR (8)      
					,[SubmittedDate]                 DATETIME         
					,[SurfaceLatLongSource]          VARCHAR (128)    
					,[Survey]                        VARCHAR (64)     
					,[Township]                      VARCHAR (8)      
					,[Trajectory]                    VARCHAR (16)     
					,[UpdatedDate]                   DATETIME         
					,[WellId]                        BIGINT           
					,[WellName]                      VARCHAR (128)    
					,[WellNumber]                    VARCHAR (64)     
					,[WellType]                      VARCHAR (32)     

					,ETL_Load_Date						DATETIME
				  
					,INDEX idx_tempdb_Permit_PermitID
						NONCLUSTERED (
							PermitID
						)
				  )

			------------------------------------------------------------------------
			-- Save Permit data
			------------------------------------------------------------------------
				SET @ErrPos = concat(@MsgTitle, '; Save Permit data')
				PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

				--------------------------------------------------------------------
				-- Unpack Permit JSON
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Unpack Permit JSON')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					INSERT INTO #Permit (
						 _duplicate
						,_error
						,_delete

						,[Abstract]                      
						,[Amended_Date]                  
						,[API_UWI]                       
						,[API_UWI_Unformatted]           
						,[ApprovedDate]                  
						,[Block]                         
						,[ContactName]                   
						,[ContactPhone]                  
						,[Country]                       
						,[County]                        
						,[DeletedDate]                   
						,[District]                      
						,[ENVBasin]                      
						,[ENVInterval]                   
						,[ENVOperator]                   
						,[ENVPeerGroup]                  
						,[ENVPlay]                       
						,[ENVRegion]                     
						,[ENVStockExchange]              
						,[ENVTicker]                     
						,[ENVWellStatus]                 
						,[ExpiredDate]                   
						,[Field]                         
						,[Formation]                     
						,[H2SArea]                       
						,[Latitude]                      
						,[Latitude_BH]                   
						,[Lease_Acres]                   
						,[LeaseName]                     
						,[LeaseNumber]                   
						,[Longitude]                     
						,[Longitude_BH]                  
						,[OperatorAddress]               
						,[OperatorCity]                  
						,[OperatorCity_30mi]             
						,[OperatorCity_50mi]             
						,[OperatorState]                 
						,[OperatorZip]                   
						,[PadID]                         
						,[PermitDepth_FT]                
						,[PermitID]                      
						,[PermitNumber]                  
						,[PermitStatus]                  
						,[PermittedLateralLength_FT]     
						,[PermittedLateralLengthSource]  
						,[PermittedMeasuredDepth_FT]     
						,[PermittedTrueVerticalDepth_FT] 
						,[PermitType]                    
						,[Range]                         
						,[RawOperator]                   
						,[Section]                       
						,[StateProvince]                 
						,[SubmittedDate]                 
						,[SurfaceLatLongSource]          
						,[Survey]                        
						,[Township]                      
						,[Trajectory]                    
						,[UpdatedDate]                   
						,[WellId]                        
						,[WellName]                      
						,[WellNumber]                    
						,[WellType]      
						,[GeomBHL_Point]                 
						,[GeomPermitted_Line]            
						,[GeomSHL_Point]                 


						,ETL_Load_Date
						)
					SELECT
						 _duplicate = count(*) OVER (PARTITION BY t0.PermitID)-1
						,_error		= 0
						,_delete			BIT

						,Abstract                      
						,Amended_Date                  
						,API_UWI                       
						,API_UWI_Unformatted           
						,ApprovedDate                  
						,Block                         
						,ContactName                   
						,ContactPhone                  
						,Country                       
						,County                        
						,DeletedDate                   
						,District                      
						,ENVBasin                      
						,ENVInterval                   
						,ENVOperator                   
						,ENVPeerGroup                  
						,ENVPlay                       
						,ENVRegion                     
						,ENVStockExchange              
						,ENVTicker                     
						,ENVWellStatus                 
						,ExpiredDate                   
						,Field                         
						,Formation                     
						,H2SArea                       
						,Latitude                      
						,Latitude_BH                   
						,Lease_Acres                   
						,LeaseName                     
						,LeaseNumber                   
						,Longitude                     
						,Longitude_BH                  
						,OperatorAddress               
						,OperatorCity                  
						,OperatorCity_30mi             
						,OperatorCity_50mi             
						,OperatorState                 
						,OperatorZip                   
						,PadID                         
						,PermitDepth_FT                
						,PermitID                      
						,PermitNumber                  
						,PermitStatus                  
						,PermittedLateralLength_FT     
						,PermittedLateralLengthSource  
						,PermittedMeasuredDepth_FT     
						,PermittedTrueVerticalDepth_FT 
						,PermitType                    
						,Range                         
						,RawOperator                   
						,Section                       
						,StateProvince                 
						,SubmittedDate                 
						,SurfaceLatLongSource          
						,Survey                        
						,Township                      
						,Trajectory                    
						,UpdatedDate                   
						,WellId                        
						,WellName                      
						,WellNumber                    
						,WellType                 
						,t1.GeoData GeomBHL_Point
						,t2.GeoData GeomPermitted_Line
						,t3.GeoData GeomSHL_Point

						,sysdatetime()
					FROM
						OPENJSON(@data)
						WITH (
							 _delete						 BIT

							,Abstract						VARCHAR (8)      
							,Amended_Date					DATETIME         
							,API_UWI						VARCHAR (32)     
							,API_UWI_Unformatted			VARCHAR (32)     
							,ApprovedDate					DATETIME         
							,Block							VARCHAR (16)     
							,ContactName					VARCHAR (128)    
							,ContactPhone					VARCHAR (32)     
							,Country						VARCHAR (64)     
							,County							VARCHAR (64)     
							,DeletedDate					DATETIME         
							,District						VARCHAR (16)     
							,ENVBasin						VARCHAR (64)     
							,ENVInterval					VARCHAR (128)    
							,ENVOperator					VARCHAR (256)    
							,ENVPeerGroup					VARCHAR (64)     
							,ENVPlay						VARCHAR (128)    
							,ENVRegion						VARCHAR (32)     
							,ENVStockExchange				VARCHAR (32)     
							,ENVTicker						VARCHAR (8)      
							,ENVWellStatus					VARCHAR (64)     
							,ExpiredDate					DATETIME         
							,Field							VARCHAR (64)     
							,Formation						VARCHAR (256)    
							,GeomBHL_Point					VARCHAR (MAX) 
							,GeomPermitted_Line				VARCHAR (max) 
							,GeomSHL_Point					VARCHAR (MAX)
							,H2SArea						INT              
							,Latitude						FLOAT (53)       
							,Latitude_BH					FLOAT (53)       
							,Lease_Acres					FLOAT (53)       
							,LeaseName						VARCHAR (64)     
							,LeaseNumber					VARCHAR (64)     
							,Longitude						FLOAT (53)       
							,Longitude_BH					FLOAT (53)       
							,OperatorAddress				VARCHAR (128)    
							,OperatorCity					VARCHAR (32)     
							,OperatorCity_30mi				VARCHAR (16)     
							,OperatorCity_50mi				VARCHAR (16)     
							,OperatorState					VARCHAR (16)     
							,OperatorZip					VARCHAR (16)     
							,PadID							VARCHAR (128)    
							,PermitDepth_FT					INT              
							,PermitID						INT              
							,PermitNumber					VARCHAR (32)     
							,PermitStatus					VARCHAR (16)     
							,PermittedLateralLength_FT		FLOAT (53)       
							,PermittedLateralLengthSource	VARCHAR (16)     
							,PermittedMeasuredDepth_FT		INT              
							,PermittedTrueVerticalDepth_FT	INT              
							,PermitType						VARCHAR (16)     
							,Range							VARCHAR (4)      
							,RawOperator					VARCHAR (128)    
							,Section						VARCHAR (8)      
							,StateProvince					VARCHAR (8)      
							,SubmittedDate					DATETIME         
							,SurfaceLatLongSource			VARCHAR (128)    
							,Survey							VARCHAR (64)     
							,Township						VARCHAR (8)      
							,Trajectory						VARCHAR (16)     
							,UpdatedDate					DATETIME         
							,WellId							BIGINT           
							,WellName						VARCHAR (128)    
							,WellNumber						VARCHAR (64)     
							,WellType						VARCHAR (32)     

							--,ETL_Load_Date		DATETIME
						) t0
						CROSS APPLY [sync].[fnGetGeometryFromStr](t0.GeomBHL_Point) t1
						CROSS APPLY [sync].[fnGetGeometryFromStr](t0.GeomPermitted_Line) t2
						CROSS APPLY [sync].[fnGetGeometryFromStr](t0.GeomSHL_Point) t3

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Validate Permit data
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Validate Permit data')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					UPDATE #Permit SET 
						 _delete	= coalesce(_delete, 0)
						,_error		= CASE 
										-- Set error true if duplicate detected
										WHEN _duplicate = 1 THEN 1
										
										-- Set error true if PermitID is null or empty string
										--WHEN PermitID IS NULL OR PermitID = '' THEN 1
										WHEN PermitID IS NULL THEN 1
										ELSE 0
									  END
						,_message	=   -- Add error message duplicate detected
									+ CASE WHEN _duplicate = 1 THEN '[ERROR: There were one or more records with the same PermitID this record will be ignored ( '+PermitID+')];' ELSE '' END
									+ CASE WHEN PermitID IS NULL OR PermitID = '' THEN '[ERROR: PermitID cannot be null or empty string)];' ELSE '' END
								
					
					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Save data to data.Permit
				--------------------------------------------------------------------
					SET @ErrPos = concat(@MsgTitle, '; Save data to data.Permit')
					PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

					----------------------------------------------------------------
					-- Process Deletes
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.Permit; Process Deletes')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						DELETE t0
						FROM
							data.Permit t0

							INNER JOIN #Permit t1
							   ON t0.PermitID = t1.PermitID

						WHERE 1=1
							AND t1.DeletedDate is null
							AND t1._delete = 1
							AND t1._error = 0

						SET @ErrPos += concat(' [ ',@@rowcount,' ]')
						PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

					----------------------------------------------------------------
					-- Process Updates
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.Permit; Process Updates')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						UPDATE t0 SET	
							 [Abstract]                      = t1.[Abstract]                      
							,[Amended_Date]                  = t1.[Amended_Date]                  
							,[API_UWI]                       = t1.[API_UWI]                       
							,[API_UWI_Unformatted]           = t1.[API_UWI_Unformatted]           
							,[ApprovedDate]                  = t1.[ApprovedDate]                  
							,[Block]                         = t1.[Block]                         
							,[ContactName]                   = t1.[ContactName]                   
							,[ContactPhone]                  = t1.[ContactPhone]                  
							,[Country]                       = t1.[Country]                       
							,[County]                        = t1.[County]                        
							,[DeletedDate]                   = t1.[DeletedDate]                   
							,[District]                      = t1.[District]                      
							,[ENVBasin]                      = t1.[ENVBasin]                      
							,[ENVInterval]                   = t1.[ENVInterval]                   
							,[ENVOperator]                   = t1.[ENVOperator]                   
							,[ENVPeerGroup]                  = t1.[ENVPeerGroup]                  
							,[ENVPlay]                       = t1.[ENVPlay]                       
							,[ENVRegion]                     = t1.[ENVRegion]                     
							,[ENVStockExchange]              = t1.[ENVStockExchange]              
							,[ENVTicker]                     = t1.[ENVTicker]                     
							,[ENVWellStatus]                 = t1.[ENVWellStatus]                 
							,[ExpiredDate]                   = t1.[ExpiredDate]                   
							,[Field]                         = t1.[Field]                         
							,[Formation]                     = t1.[Formation]    
							,[GeomBHL_Point]				 = t1.[GeomBHL_Point]                 
							,[GeomPermitted_Line]			 = t1.[GeomPermitted_Line]            
							,[GeomSHL_Point]				 = t1.[GeomSHL_Point]   
							,[H2SArea]                       = t1.[H2SArea]                       
							,[Latitude]                      = t1.[Latitude]                      
							,[Latitude_BH]                   = t1.[Latitude_BH]                   
							,[Lease_Acres]                   = t1.[Lease_Acres]                   
							,[LeaseName]                     = t1.[LeaseName]                     
							,[LeaseNumber]                   = t1.[LeaseNumber]                   
							,[Longitude]                     = t1.[Longitude]                     
							,[Longitude_BH]                  = t1.[Longitude_BH]                  
							,[OperatorAddress]               = t1.[OperatorAddress]               
							,[OperatorCity]                  = t1.[OperatorCity]                  
							,[OperatorCity_30mi]             = t1.[OperatorCity_30mi]             
							,[OperatorCity_50mi]             = t1.[OperatorCity_50mi]             
							,[OperatorState]                 = t1.[OperatorState]                 
							,[OperatorZip]                   = t1.[OperatorZip]                   
							,[PadID]                         = t1.[PadID]                         
							,[PermitDepth_FT]                = t1.[PermitDepth_FT]                
							,[PermitID]                      = t1.[PermitID]                      
							,[PermitNumber]                  = t1.[PermitNumber]                  
							,[PermitStatus]                  = t1.[PermitStatus]                  
							,[PermittedLateralLength_FT]     = t1.[PermittedLateralLength_FT]     
							,[PermittedLateralLengthSource]  = t1.[PermittedLateralLengthSource]  
							,[PermittedMeasuredDepth_FT]     = t1.[PermittedMeasuredDepth_FT]     
							,[PermittedTrueVerticalDepth_FT] = t1.[PermittedTrueVerticalDepth_FT] 
							,[PermitType]                    = t1.[PermitType]                    
							,[Range]                         = t1.[Range]                         
							,[RawOperator]                   = t1.[RawOperator]                   
							,[Section]                       = t1.[Section]                       
							,[StateProvince]                 = t1.[StateProvince]                 
							,[SubmittedDate]                 = t1.[SubmittedDate]                 
							,[SurfaceLatLongSource]          = t1.[SurfaceLatLongSource]          
							,[Survey]                        = t1.[Survey]                        
							,[Township]                      = t1.[Township]                      
							,[Trajectory]                    = t1.[Trajectory]                    
							,[UpdatedDate]                   = t1.[UpdatedDate]                   
							,[WellId]                        = t1.[WellId]                        
							,[WellName]                      = t1.[WellName]                      
							,[WellNumber]                    = t1.[WellNumber]                    
							,[WellType]                      = t1.[WellType]                      
					
							
							--,ETL_Load_Date				= t1.ETL_Load_Date

						FROM
							data.Permit t0

							INNER JOIN #Permit t1
								ON t0.PermitID = t1.PermitID

						WHERE 1=1
							AND t1._delete = 0
							AND t1._error = 0

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

					----------------------------------------------------------------
					-- Process Inserts
					----------------------------------------------------------------
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.Permit; Process Inserts')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						INSERT INTO data.Permit ( 
							  [Abstract]                       
							 ,[Amended_Date]                   
							 ,[API_UWI]                        
							 ,[API_UWI_Unformatted]            
							 ,[ApprovedDate]                   
							 ,[Block]                          
							 ,[ContactName]                    
							 ,[ContactPhone]                   
							 ,[Country]                        
							 ,[County]                         
							 ,[DeletedDate]                    
							 ,[District]                       
							 ,[ENVBasin]                       
							 ,[ENVInterval]                    
							 ,[ENVOperator]                    
							 ,[ENVPeerGroup]                   
							 ,[ENVPlay]                        
							 ,[ENVRegion]                      
							 ,[ENVStockExchange]               
							 ,[ENVTicker]                      
							 ,[ENVWellStatus]                  
							 ,[ExpiredDate]                    
							 ,[Field]                          
							 ,[Formation]           
							 ,[GeomBHL_Point]     
							 ,[GeomPermitted_Line]
							 ,[GeomSHL_Point]     
							 ,[H2SArea]                        
							 ,[Latitude]                       
							 ,[Latitude_BH]                    
							 ,[Lease_Acres]                    
							 ,[LeaseName]                      
							 ,[LeaseNumber]                    
							 ,[Longitude]                      
							 ,[Longitude_BH]                   
							 ,[OperatorAddress]                
							 ,[OperatorCity]                   
							 ,[OperatorCity_30mi]              
							 ,[OperatorCity_50mi]              
							 ,[OperatorState]                  
							 ,[OperatorZip]                    
							 ,[PadID]                          
							 ,[PermitDepth_FT]                 
							 ,[PermitID]                       
							 ,[PermitNumber]                   
							 ,[PermitStatus]                   
							 ,[PermittedLateralLength_FT]      
							 ,[PermittedLateralLengthSource]   
							 ,[PermittedMeasuredDepth_FT]      
							 ,[PermittedTrueVerticalDepth_FT]  
							 ,[PermitType]                     
							 ,[Range]                          
							 ,[RawOperator]                    
							 ,[Section]                        
							 ,[StateProvince]                  
							 ,[SubmittedDate]                  
							 ,[SurfaceLatLongSource]           
							 ,[Survey]                         
							 ,[Township]                       
							 ,[Trajectory]                     
							 ,[UpdatedDate]                    
							 ,[WellId]                         
							 ,[WellName]                       
							 ,[WellNumber]                     
							 ,[WellType]                       
					
							,ETL_Load_Date
							)
						SELECT					
							[Abstract]                      = t0.[Abstract]                     
						   ,[Amended_Date]                  = t0.[Amended_Date]                 
						   ,[API_UWI]                       = t0.[API_UWI]                      
						   ,[API_UWI_Unformatted]           = t0.[API_UWI_Unformatted]          
						   ,[ApprovedDate]                  = t0.[ApprovedDate]                 
						   ,[Block]                         = t0.[Block]                        
						   ,[ContactName]                   = t0.[ContactName]                  
						   ,[ContactPhone]                  = t0.[ContactPhone]                 
						   ,[Country]                       = t0.[Country]                      
						   ,[County]                        = t0.[County]                       
						   ,[DeletedDate]                   = t0.[DeletedDate]                  
						   ,[District]                      = t0.[District]                     
						   ,[ENVBasin]                      = t0.[ENVBasin]                     
						   ,[ENVInterval]                   = t0.[ENVInterval]                  
						   ,[ENVOperator]                   = t0.[ENVOperator]                  
						   ,[ENVPeerGroup]                  = t0.[ENVPeerGroup]                 
						   ,[ENVPlay]                       = t0.[ENVPlay]                      
						   ,[ENVRegion]                     = t0.[ENVRegion]                    
						   ,[ENVStockExchange]              = t0.[ENVStockExchange]             
						   ,[ENVTicker]                     = t0.[ENVTicker]                    
						   ,[ENVWellStatus]                 = t0.[ENVWellStatus]                
						   ,[ExpiredDate]                   = t0.[ExpiredDate]                  	
						   ,[Field]                         = t0.[Field]                        
						   ,[Formation]                     = t0.[Formation]
						   ,[GeomBHL_Point]				= t0.[GeomBHL_Point]     
						   ,[GeomPermitted_Line]			= t0.[GeomPermitted_Line]
						   ,[GeomSHL_Point]				= t0.[GeomSHL_Point]     
						   ,[H2SArea]                       = t0.[H2SArea]                      
						   ,[Latitude]                      = t0.[Latitude]                     
						   ,[Latitude_BH]                   = t0.[Latitude_BH]                  
						   ,[Lease_Acres]                   = t0.[Lease_Acres]                  
						   ,[LeaseName]                     = t0.[LeaseName]                    
						   ,[LeaseNumber]                   = t0.[LeaseNumber]                  
						   ,[Longitude]                     = t0.[Longitude]                    
						   ,[Longitude_BH]                  = t0.[Longitude_BH]                 
						   ,[OperatorAddress]               = t0.[OperatorAddress]              
						   ,[OperatorCity]                  = t0.[OperatorCity]                 
						   ,[OperatorCity_30mi]             = t0.[OperatorCity_30mi]            
						   ,[OperatorCity_50mi]             = t0.[OperatorCity_50mi]            
						   ,[OperatorState]                 = t0.[OperatorState]                
						   ,[OperatorZip]                   = t0.[OperatorZip]                  
						   ,[PadID]                         = t0.[PadID]                        
						   ,[PermitDepth_FT]                = t0.[PermitDepth_FT]               
						   ,[PermitID]                      = t0.[PermitID]                     
						   ,[PermitNumber]                  = t0.[PermitNumber]                 
						   ,[PermitStatus]                  = t0.[PermitStatus]                 
						   ,[PermittedLateralLength_FT]     = t0.[PermittedLateralLength_FT]    
						   ,[PermittedLateralLengthSource]  = t0.[PermittedLateralLengthSource] 
						   ,[PermittedMeasuredDepth_FT]     = t0.[PermittedMeasuredDepth_FT]    
						   ,[PermittedTrueVerticalDepth_FT] = t0.[PermittedTrueVerticalDepth_FT]
						   ,[PermitType]                    = t0.[PermitType]                   
						   ,[Range]                         = t0.[Range]                        
						   ,[RawOperator]                   = t0.[RawOperator]                  
						   ,[Section]                       = t0.[Section]                      
						   ,[StateProvince]                 = t0.[StateProvince]                
						   ,[SubmittedDate]                 = t0.[SubmittedDate]                
						   ,[SurfaceLatLongSource]          = t0.[SurfaceLatLongSource]         
						   ,[Survey]                        = t0.[Survey]                       
						   ,[Township]                      = t0.[Township]                     
						   ,[Trajectory]                    = t0.[Trajectory]                   
						   ,[UpdatedDate]                   = t0.[UpdatedDate]                  
						   ,[WellId]                        = t0.[WellId]                       
						   ,[WellName]                      = t0.[WellName]                     
						   ,[WellNumber]                    = t0.[WellNumber]                   
						   ,[WellType]                      = t0.[WellType]                     

							,ETL_Load_Date					= t0.ETL_Load_Date				
						FROM
							#Permit t0

							LEFT OUTER JOIN data.Permit t1
								ON t0.PermitID = t1.PermitID

						WHERE 1=1
							AND t1.PermitID		IS NULL

							AND t0._delete = 0
							AND t0._error = 0

					SET @ErrPos += concat(' [ ',@@rowcount,' ]')
					PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)

				--------------------------------------------------------------------
				-- Error Output
				--------------------------------------------------------------------
					IF @NoOutput = 0
					BEGIN
						SET @ErrPos = concat(@MsgTitle, '; Save data to data.Permit')
						PRINT concat(sysdatetime(),' | INFO | ',@ErrPos)

						SELECT 
							 _row_id
                            ,_delete
                            ,_error
                            ,_message

							,[Abstract]                     
							,[Amended_Date]                 
							,[API_UWI]                      
							,[API_UWI_Unformatted]          
							,[ApprovedDate]                 
							,[Block]                        
							,[ContactName]                  
							,[ContactPhone]                 
							,[Country]                      
							,[County]                       
							,[DeletedDate]                  
							,[District]                     
							,[ENVBasin]                     
							,[ENVInterval]                  
							,[ENVOperator]                  
							,[ENVPeerGroup]                 
							,[ENVPlay]                      
							,[ENVRegion]                    
							,[ENVStockExchange]             
							,[ENVTicker]                    
							,[ENVWellStatus]                
							,[ExpiredDate]                  
							,[Field]                        
							,[Formation]                    
							,[GeomBHL_PointSTR]                
							,[GeomPermitted_LineSTR]           
							,[GeomSHL_PointSTR]                
							,[H2SArea]                      
							,[Latitude]                     
							,[Latitude_BH]                  
							,[Lease_Acres]                  
							,[LeaseName]                    
							,[LeaseNumber]                  
							,[Longitude]                    
							,[Longitude_BH]                 
							,[OperatorAddress]              
							,[OperatorCity]                 
							,[OperatorCity_30mi]            
							,[OperatorCity_50mi]            
							,[OperatorState]                
							,[OperatorZip]                  
							,[PadID]                        
							,[PermitDepth_FT]               
							,[PermitID]                     
							,[PermitNumber]                 
							,[PermitStatus]                 
							,[PermittedLateralLength_FT]    
							,[PermittedLateralLengthSource] 
							,[PermittedMeasuredDepth_FT]    
							,[PermittedTrueVerticalDepth_FT]
							,[PermitType]                   
							,[Range]                        
							,[RawOperator]                  
							,[Section]                      
							,[StateProvince]                
							,[SubmittedDate]                
							,[SurfaceLatLongSource]         
							,[Survey]                       
							,[Township]                     
							,[Trajectory]                   
							,[UpdatedDate]                  
							,[WellId]                       
							,[WellName]                     
							,[WellNumber]                   
							,[WellType]                     
					
							,ETL_Load_Date
						FROM 
							#Permit
						WHERE 1=1
							AND _error = 1

						SET @ErrPos += concat(' [ ',@@rowcount,' ]')
						PRINT concat(sysdatetime(),' | INFO | '+@ErrPos)
					END

		END TRY
		BEGIN CATCH
			-- Errors here are fatal; format and throw exception to caller
			SET @ErrMsg = concat('Failed to ',@ErrPos,'  { ',error_number(),' } ',error_message())
			PRINT concat(sysdatetime(),' | *ERR | ',@ErrMsg);
			THROW 2147483647,@ErrMsg,1;
		END CATCH	
		
		PRINT concat(sysdatetime(),' | INFO | ',@MsgTitle, '; *** Completed ***')
END
GO
PRINT N'Update complete.';


GO
